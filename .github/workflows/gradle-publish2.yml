name: APK Java ãƒ“ãƒ«ãƒ‰ (ç½²åæ¤œè¨¼æ©Ÿèƒ½ä»˜ã)

on:
  release:
    types: [created]
  push:
    branches: [ main, master ]
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      # setup-androidã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒé©åˆ‡ã«è¨­å®šã™ã‚‹ãŸã‚ã€ã“ã®è¡Œã¯æ®‹ã—ã¦ãŠãã¾ã™ã€‚
      ANDROID_HOME: ${{ github.workspace }}/.android-sdk

    steps:
      - name: 1. ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: 2. JDK 17ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          # Gradleã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–
          cache: gradle

      - name: 3. gradlew ã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸
        run: chmod +x ./gradlew

      - name: 4. Gradleã‚·ã‚¹ãƒ†ãƒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¼·åˆ¶å‰Šé™¤
        run: rm -rf ~/.gradle/caches

      # ----------------------------------------------------
      # 4.1. Android SDKã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # ----------------------------------------------------
      - name: 4.1. Android SDKã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        uses: android-actions/setup-android@v3
        with:
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® app/build.gradle ã® compileSdk (android-33) ã«åˆã‚ã›ã‚‹
          sdk-version: '33'
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® buildToolsVersion (33.0.2) ã«åˆã‚ã›ã‚‹
          build-tools: '33.0.2'
          # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ‰¿è«¾ã‚‚ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å†…ã§è‡ªå‹•çš„ã«å‡¦ç†ã•ã‚Œã¾ã™ã€‚

      # ----------------------------------------------------
      # 4.5. ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å…ƒã—ç½²åç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š (CRITICAL STEP)
      # ----------------------------------------------------
      - name: 4.5. ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å…ƒã—ç½²åç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
        id: setup_signing
        run: |
          echo "--- ç½²åãƒ•ã‚¡ã‚¤ãƒ«ã¨ç’°å¢ƒå¤‰æ•°ã®è¨­å®šã‚’é–‹å§‹ ---"

          # Shellå†…ã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          KEY_BASE64="${{ secrets.SIGNING_KEY_BASE64 }}"
          if [ -z "$KEY_BASE64" ]; then
            echo "secrets.SIGNING_KEY_BASE64 ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ç½²åè¨­å®šã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            # æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«ç½²åãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸã“ã¨ã‚’ä¼é”
            echo "SIGNED=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚’ç¶šè¡Œã—ã¾ã™ã€‚"
          
          # 1. Base64ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜
          echo "$KEY_BASE64" | base64 --decode > release.keystore
          
          # 2. ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š (å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã§ ${{ env.VARIABLE }} ã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã‚‹)
          echo "SIGNING_KEY_FILE=$(pwd)/release.keystore" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
          
          # æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«ç½²åãŒè¨­å®šã•ã‚ŒãŸã“ã¨ã‚’ä¼é”
          echo "SIGNED=true" >> $GITHUB_OUTPUT
          
          echo "--- ç½²åç’°å¢ƒå¤‰æ•°ã‚’ $GITHUB_ENV ã«è¨­å®šå®Œäº† ---"

      # ----------------------------------------------------
      # 5. ãƒªãƒªãƒ¼ã‚¹APKã®ãƒ“ãƒ«ãƒ‰ (assembleRelease) - ç½²åã‚ã‚Š/ãªã—ã§åˆ†é›¢
      # ----------------------------------------------------
      
      # 5.1. ç½²åãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹å ´åˆ: ç½²åä»˜ããƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
      # ã‚¹ãƒ†ãƒƒãƒ—4.5ã§SIGNED=trueãŒè¨­å®šã•ã‚ŒãŸå ´åˆã«å®Ÿè¡Œã•ã‚Œã‚‹
      - name: 5.1. ç½²åä»˜ããƒªãƒªãƒ¼ã‚¹APKã‚’ãƒ“ãƒ«ãƒ‰
        if: ${{ steps.setup_signing.outputs.SIGNED == 'true' }}
        run: |
          echo "ç½²åãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ¤œå‡ºã€‚ç½²åä»˜ããƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚"
          # Gradle Project Propertyã¨ã—ã¦ç½²åæƒ…å ±ã‚’æ˜ç¤ºçš„ã«æ¸¡ã™
          ./gradlew clean assembleRelease --no-daemon -Dgradle.parallel=false --stacktrace \
            -Pandroid.injected.signing.store.file=${{ env.SIGNING_KEY_FILE }} \
            -Pandroid.injected.signing.store.password=${{ env.KEYSTORE_PASSWORD }} \
            -Pandroid.injected.signing.key.alias=${{ env.KEY_ALIAS }} \
            -Pandroid.injected.signing.key.password=${{ env.KEY_PASSWORD }}

      # 5.1.1. ã€æ¤œè¨¼ã€‘ç½²åãŒæˆåŠŸã—ãŸã‹ãƒã‚§ãƒƒã‚¯
      - name: 5.1.1. ã€æ¤œè¨¼ã€‘ç”Ÿæˆã•ã‚ŒãŸAPKã®ç½²åæƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯
        if: ${{ steps.setup_signing.outputs.SIGNED == 'true' }}
        run: |
          # æœ€çµ‚çš„ã«ç”Ÿæˆã•ã‚ŒãŸAPKãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å–å¾—ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã«ä¾å­˜ï¼‰
          APK_PATH=$(find app/build/outputs/apk/release -name "app-release.apk" | head -n 1)
          
          if [ -z "$APK_PATH" ]; then
            echo "::error:: app-release.apk ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚Gradleãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
            exit 1
          fi
          
          echo "æ¤œè¨¼å¯¾è±¡APKãƒ•ã‚¡ã‚¤ãƒ«: $APK_PATH"

          # jarsigner ã§ç½²åæƒ…å ±ã‚’æ¤œè¨¼
          if jarsigner -verify -verbose -certs "$APK_PATH" | grep "signature was verified"; then
              echo "::notice:: ğŸ‰ ã€ç½²åæˆåŠŸã€‘APKãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ã«ã‚ˆã£ã¦æ­£ã—ãç½²åã•ã‚Œã¦ã„ã¾ã™ã€‚"
              echo "--- ç½²åæƒ…å ±ã®è©³ç´° ---"
              jarsigner -verify -certs -verbose "$APK_PATH" | head -n 10
          else
              echo "::error:: âŒ ã€ç½²åå¤±æ•—ã€‘APKã¯ç”Ÿæˆã•ã‚Œã¾ã—ãŸãŒã€ç½²åæƒ…å ±ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
              echo "è€ƒãˆã‚‰ã‚Œã‚‹åŸå› ï¼š"
              echo "  1. GradleãŒç½²åã‚­ãƒ¼ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œãªã‹ã£ãŸ (storeFile, password, aliasã®ã„ãšã‚Œã‹é–“é•ã„)"
              echo "  2. ã‚­ãƒ¼ã‚¹ãƒˆã‚¢ã¾ãŸã¯è¨¼æ˜æ›¸ãŒç ´æã—ã¦ã„ã‚‹"
              exit 1 # ãƒ“ãƒ«ãƒ‰ã‚’å¤±æ•—ã•ã›ã‚‹
          fi


      # 5.2. ç½²åãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„å ´åˆ: æœªç½²åãƒ“ãƒ«ãƒ‰ã‚’**å¼·åˆ¶**å®Ÿè¡Œ
      # ã‚¹ãƒ†ãƒƒãƒ—4.5ã§SIGNED=falseãŒè¨­å®šã•ã‚ŒãŸå ´åˆã«å®Ÿè¡Œã•ã‚Œã‚‹
      - name: 5.2. æœªç½²åãƒªãƒªãƒ¼ã‚¹APKã‚’å¼·åˆ¶ãƒ“ãƒ«ãƒ‰
        if: ${{ steps.setup_signing.outputs.SIGNED == 'false' }}
        run: |
          echo "ç½²åãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒãªã„ãŸã‚ã€æœªç½²åãƒ“ãƒ«ãƒ‰ (assembleRelease) ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚"
          # æœªç½²åãƒ“ãƒ«ãƒ‰ã‚’å¼·åˆ¶ã™ã‚‹ãŸã‚ã« 'signingConfig=debug' ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆ
          ./gradlew clean assembleRelease --no-daemon -Dgradle.parallel=false --stacktrace \
            -Pandroid.injected.signing.config=debug

      # ----------------------------------------------------
      # 6. æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (ç½²åæ¸ˆã¿/æœªç½²åã«ã‹ã‹ã‚ã‚‰ãšã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)
      # ----------------------------------------------------
      - name: 6. ãƒªãƒªãƒ¼ã‚¹APKã®æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: liefantidia-apk
          path: app/build/outputs/apk/release/
          retention-days: 7